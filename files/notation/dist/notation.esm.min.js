var $="http://www.w3.org/2000/svg",O=class{constructor(t){this.seed=t}next(){return this.seed?(2**31-1&(this.seed=Math.imul(48271,this.seed)))/2**31:Math.random()}};function k(e,t,s,i,n){return{type:"path",ops:N(e,t,s,i,n)}}function j(e,t,s){let i=(e||[]).length;if(i>2){let n=[];for(let a=0;a<i-1;a++)n.push(...N(e[a][0],e[a][1],e[a+1][0],e[a+1][1],s));return t&&n.push(...N(e[i-1][0],e[i-1][1],e[0][0],e[0][1],s)),{type:"path",ops:n}}return i===2?k(e[0][0],e[0][1],e[1][0],e[1][1],s):{type:"path",ops:[]}}function q(e,t,s,i,n){return function(a,r){return j(a,!0,r)}([[e,t],[e+s,t],[e+s,t+i],[e,t+i]],n)}function T(e,t,s,i,n){return function(a,r,o,c){let[v,f]=B(c.increment,a,r,c.rx,c.ry,1,c.increment*R(.1,R(.4,1,o),o),o),_=L(v,null,o);if(!o.disableMultiStroke){let[g]=B(c.increment,a,r,c.rx,c.ry,1.5,0,o),d=L(g,null,o);_=_.concat(d)}return{estimatedPoints:f,opset:{type:"path",ops:_}}}(e,t,n,function(a,r,o){let c=Math.sqrt(2*Math.PI*Math.sqrt((Math.pow(a/2,2)+Math.pow(r/2,2))/2)),v=Math.max(o.curveStepCount,o.curveStepCount/Math.sqrt(200)*c),f=2*Math.PI/v,_=Math.abs(a/2),g=Math.abs(r/2),d=1-o.curveFitting;return _+=w(_*d,o),g+=w(g*d,o),{increment:f,rx:_,ry:g}}(s,i,n)).opset}function P(e){return e.randomizer||(e.randomizer=new O(e.seed||0)),e.randomizer.next()}function R(e,t,s,i=1){return s.roughness*i*(P(s)*(t-e)+e)}function w(e,t,s=1){return R(-e,e,t,s)}function N(e,t,s,i,n,a=!1){let r=a?n.disableMultiStrokeFill:n.disableMultiStroke,o=A(e,t,s,i,n,!0,!1);if(r)return o;let c=A(e,t,s,i,n,!0,!0);return o.concat(c)}function A(e,t,s,i,n,a,r){let o=Math.pow(e-s,2)+Math.pow(t-i,2),c=Math.sqrt(o),v=1;v=c<200?1:c>500?.4:-.0016668*c+1.233334;let f=n.maxRandomnessOffset||0;f*f*100>o&&(f=c/10);let _=f/2,g=.2+.2*P(n),d=n.bowing*n.maxRandomnessOffset*(i-t)/200,h=n.bowing*n.maxRandomnessOffset*(e-s)/200;d=w(d,n,v),h=w(h,n,v);let l=[],p=()=>w(_,n,v),u=()=>w(f,n,v);return a&&(r?l.push({op:"move",data:[e+p(),t+p()]}):l.push({op:"move",data:[e+w(f,n,v),t+w(f,n,v)]})),r?l.push({op:"bcurveTo",data:[d+e+(s-e)*g+p(),h+t+(i-t)*g+p(),d+e+2*(s-e)*g+p(),h+t+2*(i-t)*g+p(),s+p(),i+p()]}):l.push({op:"bcurveTo",data:[d+e+(s-e)*g+u(),h+t+(i-t)*g+u(),d+e+2*(s-e)*g+u(),h+t+2*(i-t)*g+u(),s+u(),i+u()]}),l}function L(e,t,s){let i=e.length,n=[];if(i>3){let a=[],r=1-s.curveTightness;n.push({op:"move",data:[e[1][0],e[1][1]]});for(let o=1;o+2<i;o++){let c=e[o];a[0]=[c[0],c[1]],a[1]=[c[0]+(r*e[o+1][0]-r*e[o-1][0])/6,c[1]+(r*e[o+1][1]-r*e[o-1][1])/6],a[2]=[e[o+1][0]+(r*e[o][0]-r*e[o+2][0])/6,e[o+1][1]+(r*e[o][1]-r*e[o+2][1])/6],a[3]=[e[o+1][0],e[o+1][1]],n.push({op:"bcurveTo",data:[a[1][0],a[1][1],a[2][0],a[2][1],a[3][0],a[3][1]]})}if(t&&t.length===2){let o=s.maxRandomnessOffset;n.push({op:"lineTo",data:[t[0]+w(o,s),t[1]+w(o,s)]})}}else i===3?(n.push({op:"move",data:[e[1][0],e[1][1]]}),n.push({op:"bcurveTo",data:[e[1][0],e[1][1],e[2][0],e[2][1],e[2][0],e[2][1]]})):i===2&&n.push(...N(e[0][0],e[0][1],e[1][0],e[1][1],s));return n}function B(e,t,s,i,n,a,r,o){let c=[],v=[],f=w(.5,o)-Math.PI/2;v.push([w(a,o)+t+.9*i*Math.cos(f-e),w(a,o)+s+.9*n*Math.sin(f-e)]);for(let _=f;_<2*Math.PI+f-.01;_+=e){let g=[w(a,o)+t+i*Math.cos(_),w(a,o)+s+n*Math.sin(_)];c.push(g),v.push(g)}return v.push([w(a,o)+t+i*Math.cos(f+2*Math.PI+.5*r),w(a,o)+s+n*Math.sin(f+2*Math.PI+.5*r)]),v.push([w(a,o)+t+.98*i*Math.cos(f+r),w(a,o)+s+.98*n*Math.sin(f+r)]),v.push([w(a,o)+t+.9*i*Math.cos(f+.5*r),w(a,o)+s+.9*n*Math.sin(f+.5*r)]),[v,c]}function D(e,t){return{maxRandomnessOffset:2,roughness:e==="highlight"?3:1.5,bowing:1,stroke:"#000",strokeWidth:1.5,curveTightness:0,curveFitting:.95,curveStepCount:9,fillStyle:"hachure",fillWeight:-1,hachureAngle:-41,hachureGap:-1,dashOffset:-1,dashGap:-1,zigzagOffset:-1,combineNestedSvgPaths:!1,disableMultiStroke:e!=="double",disableMultiStrokeFill:!1,seed:t}}function F(e,t,s,i,n,a){let r=[],o=s.strokeWidth||2,c=function(d){let h=d.padding;if(h||h===0){if(typeof h=="number")return[h,h,h,h];if(Array.isArray(h)){let l=h;if(l.length)switch(l.length){case 4:return[...l];case 1:return[l[0],l[0],l[0],l[0]];case 2:return[...l,...l];case 3:return[...l,l[1]];default:return[l[0],l[1],l[2],l[3]]}}}return[5,5,5,5]}(s),v=s.animate===void 0||!!s.animate,f=s.iterations||2,_=s.rtl?1:0,g=D("single",a);switch(s.type){case"underline":{let d=t.y+t.h+c[2];for(let h=_;h<f+_;h++)h%2?r.push(k(t.x+t.w,d,t.x,d,g)):r.push(k(t.x,d,t.x+t.w,d,g));break}case"strike-through":{let d=t.y+t.h/2;for(let h=_;h<f+_;h++)h%2?r.push(k(t.x+t.w,d,t.x,d,g)):r.push(k(t.x,d,t.x+t.w,d,g));break}case"box":{let d=t.x-c[3],h=t.y-c[0],l=t.w+(c[1]+c[3]),p=t.h+(c[0]+c[2]);for(let u=0;u<f;u++)r.push(q(d,h,l,p,g));break}case"bracket":{let d=Array.isArray(s.brackets)?s.brackets:s.brackets?[s.brackets]:["right"],h=t.x-2*c[3],l=t.x+t.w+2*c[1],p=t.y-2*c[0],u=t.y+t.h+2*c[2];for(let x of d){let m;switch(x){case"bottom":m=[[h,t.y+t.h],[h,u],[l,u],[l,t.y+t.h]];break;case"top":m=[[h,t.y],[h,p],[l,p],[l,t.y]];break;case"left":m=[[t.x,p],[h,p],[h,u],[t.x,u]];break;case"right":m=[[t.x+t.w,p],[l,p],[l,u],[t.x+t.w,u]]}m&&r.push(j(m,!1,g))}break}case"crossed-off":{let d=t.x,h=t.y,l=d+t.w,p=h+t.h;for(let u=_;u<f+_;u++)u%2?r.push(k(l,p,d,h,g)):r.push(k(d,h,l,p,g));for(let u=_;u<f+_;u++)u%2?r.push(k(d,p,l,h,g)):r.push(k(l,h,d,p,g));break}case"circle":{let d=D("double",a),h=t.w+(c[1]+c[3]),l=t.h+(c[0]+c[2]),p=t.x-c[3]+h/2,u=t.y-c[0]+l/2,x=Math.floor(f/2),m=f-2*x;for(let b=0;b<x;b++)r.push(T(p,u,h,l,d));for(let b=0;b<m;b++)r.push(T(p,u,h,l,g));break}case"highlight":{let d=D("highlight",a);o=.95*t.h;let h=t.y+t.h/2;for(let l=_;l<f+_;l++)l%2?r.push(k(t.x+t.w,h,t.x,h,d)):r.push(k(t.x,h,t.x+t.w,h,d));break}}if(r.length){let d=function(x){let m=[];for(let b of x){let y="";for(let S of b.ops){let M=S.data;switch(S.op){case"move":y.trim()&&m.push(y.trim()),y=`M${M[0]} ${M[1]} `;break;case"bcurveTo":y+=`C${M[0]} ${M[1]}, ${M[2]} ${M[3]}, ${M[4]} ${M[5]} `;break;case"lineTo":y+=`L${M[0]} ${M[1]} `}}y.trim()&&m.push(y.trim())}return m}(r),h=[],l=[],p=0,u=(x,m,b)=>x.setAttribute(m,b);for(let x of d){let m=document.createElementNS($,"path");if(u(m,"d",x),u(m,"fill","none"),u(m,"stroke",s.color||"currentColor"),u(m,"stroke-width",""+o),v){let b=m.getTotalLength();h.push(b),p+=b}e.appendChild(m),l.push(m)}if(v){let x=0;for(let m=0;m<l.length;m++){let b=l[m],y=h[m],S=p?n*(y/p):0,M=i+x,C=b.style;C.strokeDashoffset=""+y,C.strokeDasharray=""+y,C.animation=`rough-notation-dash ${S}ms ease-out ${M}ms forwards`,x+=S}}}}var z=class{constructor(t,s){this._state="unattached",this._resizing=!1,this._seed=Math.floor(Math.random()*2**31),this._lastSizes=[],this._animationDelay=0,this._resizeListener=()=>{this._resizing||(this._resizing=!0,setTimeout(()=>{this._resizing=!1,this._state==="showing"&&this.haveRectsChanged()&&this.show()},400))},this._e=t,this._config=JSON.parse(JSON.stringify(s)),this.attach()}get animate(){return this._config.animate}set animate(t){this._config.animate=t}get animationDuration(){return this._config.animationDuration}set animationDuration(t){this._config.animationDuration=t}get iterations(){return this._config.iterations}set iterations(t){this._config.iterations=t}get color(){return this._config.color}set color(t){this._config.color!==t&&(this._config.color=t,this.refresh())}get strokeWidth(){return this._config.strokeWidth}set strokeWidth(t){this._config.strokeWidth!==t&&(this._config.strokeWidth=t,this.refresh())}get padding(){return this._config.padding}set padding(t){this._config.padding!==t&&(this._config.padding=t,this.refresh())}attach(){if(this._state==="unattached"&&this._e.parentElement){(function(){if(!window.__rno_kf_s){let n=window.__rno_kf_s=document.createElement("style");n.textContent="@keyframes rough-notation-dash { to { stroke-dashoffset: 0; } }",document.head.appendChild(n)}})();let t=this._svg=document.createElementNS($,"svg");t.setAttribute("class","rough-annotation");let s=t.style;s.position="absolute",s.top="0",s.left="0",s.overflow="visible",s.pointerEvents="none",s.width="100px",s.height="100px";let i=this._config.type==="highlight";if(this._e.insertAdjacentElement(i?"beforebegin":"afterend",t),this._state="not-showing",i){let n=window.getComputedStyle(this._e).position;(!n||n==="static")&&(this._e.style.position="relative")}this.attachListeners()}}detachListeners(){window.removeEventListener("resize",this._resizeListener),this._ro&&this._ro.unobserve(this._e)}attachListeners(){this.detachListeners(),window.addEventListener("resize",this._resizeListener,{passive:!0}),!this._ro&&"ResizeObserver"in window&&(this._ro=new window.ResizeObserver(t=>{for(let s of t)s.contentRect&&this._resizeListener()})),this._ro&&this._ro.observe(this._e)}haveRectsChanged(){if(this._lastSizes.length){let t=this.rects();if(t.length!==this._lastSizes.length)return!0;for(let s=0;s<t.length;s++)if(!this.isSameRect(t[s],this._lastSizes[s]))return!0}return!1}isSameRect(t,s){let i=(n,a)=>Math.round(n)===Math.round(a);return i(t.x,s.x)&&i(t.y,s.y)&&i(t.w,s.w)&&i(t.h,s.h)}isShowing(){return this._state!=="not-showing"}refresh(){this.isShowing()&&!this.pendingRefresh&&(this.pendingRefresh=Promise.resolve().then(()=>{this.isShowing()&&this.show(),delete this.pendingRefresh}))}show(){switch(this._state){case"unattached":break;case"showing":this.hide(),this._svg&&this.render(this._svg,!0);break;case"not-showing":this.attach(),this._svg&&this.render(this._svg,!1)}}hide(){if(this._svg)for(;this._svg.lastChild;)this._svg.removeChild(this._svg.lastChild);this._state="not-showing"}remove(){this._svg&&this._svg.parentElement&&this._svg.parentElement.removeChild(this._svg),this._svg=void 0,this._state="unattached",this.detachListeners()}render(t,s){let i=this._config;s&&(i=JSON.parse(JSON.stringify(this._config)),i.animate=!1);let n=this.rects(),a=0;n.forEach(c=>a+=c.w);let r=i.animationDuration||800,o=0;for(let c=0;c<n.length;c++){let v=r*(n[c].w/a);F(t,n[c],i,o+this._animationDelay,v,this._seed),o+=v}this._lastSizes=n,this._state="showing"}rects(){let t=[];if(this._svg)if(this._config.multiline){let s=this._e.getClientRects();for(let i=0;i<s.length;i++)t.push(this.svgRect(this._svg,s[i]))}else t.push(this.svgRect(this._svg,this._e.getBoundingClientRect()));return t}svgRect(t,s){let i=t.getBoundingClientRect(),n=s;return{x:(n.x||n.left)-(i.x||i.left),y:(n.y||n.top)-(i.y||i.top),w:n.width,h:n.height}}};function W(e,t){return new z(e,t)}var I=e=>e?Array.isArray(e)?e:[e]:[],H=e=>e==null||e==="";var E=class{constructor({mindMap:t}){this.mindMap=t,this.defaultConfig={type:"circle",color:this.mindMap.opt.hoverRectColor,strokeWidth:1,padding:20,animate:!0},this.cacheHandleBeingExportSvg=null,this.cacheHandleDragCloneNode=null,this.bindEvent()}bindEvent(){this.renderNodeNotation=this.renderNodeNotation.bind(this),this.mindMap.on("node_layout_end",this.renderNodeNotation),this.setNotation=this.setNotation.bind(this),this.mindMap.command.add("SET_NOTATION",this.setNotation),this.handleBeingExportSvg=this.handleBeingExportSvg.bind(this),this.cacheHandleBeingExportSvg=this.mindMap.opt.handleBeingExportSvg,this.mindMap.opt.handleBeingExportSvg=this.handleBeingExportSvg,this.handleDragCloneNode=this.handleDragCloneNode.bind(this),this.cacheHandleDragCloneNode=this.mindMap.opt.handleDragCloneNode,this.mindMap.opt.handleDragCloneNode=this.handleDragCloneNode}unBindEvent(){this.mindMap.off("node_layout_end",this.renderNodeNotation),this.mindMap.command.remove("SET_NOTATION",this.setNotation),this.mindMap.opt.handleBeingExportSvg=this.cacheHandleBeingExportSvg,this.mindMap.opt.handleDragCloneNode=this.cacheHandleDragCloneNode}renderNodeNotation(t){setTimeout(()=>{let s=t.getData("notation");if(s){let{show:i,config:n}=s;if(i){t.notationObj&&t.notationObj.remove();let a={...this.defaultConfig};Object.keys(this.defaultConfig).forEach(o=>{H(n[o])||(a[o]=n[o])}),t.notationObj=W(t.group.findOne(".smm-node-shape").node,a),t.notationObj.haveRectsChanged=()=>!1,t.notationObj._resizeListener=()=>{},t.notationObj.show();let{scaleX:r}=this.mindMap.draw.transform();Array.from(t.notationObj._svg.children).forEach(o=>{o.style.transform=`scale(${1/r})`})}else t.notationObj&&t.notationObj.remove()}},0)}setNotation(t,s,i){t=I(t);let n=this.mindMap.renderer.activeNodeList;if(n.length<=0&&t.length<=0)return;(t.length>0?t:n).forEach(o=>{this.mindMap.execCommand("SET_NODE_DATA",o,{notation:{show:s,config:{...i||{}}}}),o.needLayout=!0}),this.mindMap.render(null)}handleBeingExportSvg(t){return t.find(".rough-annotation").forEach(i=>{let n=i.children();n&&n.length>0&&n.forEach(a=>{a.css("stroke-dashoffset",""),a.css("stroke-dasharray",""),a.css("animation","")})}),t}handleDragCloneNode(t){t.find(".rough-annotation").forEach(i=>{i.remove()})}beforePluginRemove(){this.unBindEvent()}beforePluginDestroy(){this.unBindEvent()}};E.instanceName="notation";var K=E;export{K as default};
